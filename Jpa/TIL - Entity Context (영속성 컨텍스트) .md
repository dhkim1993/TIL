# TIL - Entity Context (영속성 컨텍스트) 

### 2019.11.18 Mon

### 영속성 컨텍스트는 애플리케이션과 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 같은 역할을 한다.

- ## 1차 캐시
영속성 상태의 엔티티는 모두 이곳에 저장된다. 내부에 Map 이 있는데 key 는 @Id(기본키) 로 매핑한 식별자고 value 는 엔티티 인스턴스다.
영속성 등록을 할때 1차 캐시에 key(기본키데이터),value(인스턴스),스냅샷 이 저장되며 crud 를 할때 1차 캐시먼저 탐색후 값이 있으면 리턴, 없으면 디비에서 탐색한다.

- ## 동일성 보장 
```java
Member a = em.find(Member.class, “member1”);
Member b = em.find(Member.class, “member1”);
```
a==b 는 true 이다. 1차캐시 에서 같은 엔티티 인스턴스를 반환한다.

- ## 트랜잭션을 지원하는 쓰기 지연
엔티티를 등록할때 insert sql 을 디비로 바로 보내지않고 쓰기 지연 sql 저장소가 있다. 저장소에 모아놓았다가 commit(flush자동) 할때 한번에 디비로 보내는 방식이다. 이렇게 하면 성능면으로 효율적이다

- ## 변경 감지
1차 캐시에 있는 스냅샷이란 처음등록할때 그 값을 복사 해준다. 해서 나중에 수정사항이 있는지 스냅샷과 비교해서 수정사항이 있으면 update sql 을 만들어 sql 저장소에 보내고 commit 한다.
변경감지는 영속성 컨텍스트가 관리하는 영속 상태의 엔티티에만 적용됨.

- ## flush
영속성 컨틱스트의 변경 내용을 디비에 반영한다. 

1. 변경감지가 동작해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티르 찾는다. 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 sql 저장소에 등록한다.
2. 쓰기 지연 sql 저장소의 쿼리를 디비에 전송 (insert,update,delete)
> flush 방법 3가지
>> 1. em.flush() 직접호출<br>
>> 2. 트랜잭션 commit 시 플러시가 자동 호출<br>
>> 3. JPQL 쿼리 실행시 플러시 자동 호출<br>


- ## 지연 로딩


